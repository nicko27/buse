<div class="flex-h w-available">
    <div class="block" id="unites-manual">
        <div class="block__title glass">
            <div class="block__title-left">
                Gestion des unités ajoutées manuellement
                <a onclick="unitesManualTable.addRow([],'start')">
                    <i class="fa fa-circle-plus"></i>
                </a>
            </div>
            <div class="block__title-center">
                <div id="maj__text-update" class="hidden progress-container">
                    <div class="progress-bar"></div>
                </div>
            </div>
        </div>

        <div class="block__content flex-h">
            <table id="unitesManualTbl">
                <thead>
                    <tr>
                        <th id="id" th-hide th-text-default="0">id</th>
                        <th th-edit='{"required": true}' th-sort th-class="small-caps-under" id="name">Unité</th>
                        <th id="cu" th-hide>code Unité</th>
                        <th th-choice id="cieCu" th-sort>Compagnie</th>
                    </tr>
                </thead>
                <tbody>
                    {% for unites in unites_manuelles_tbl %}
                        <tr id="{{unites.id}}" name="{{ unites.id }}">
                            <td id="id_{{ unites.id }}" name="id_{{  unites.id }}">{{ unites.id }}</td>
                            <td id="name_{{ unites.id }}" name="name_{{ unites.id }}">{{ unites.name }}</td>
                            <td id="cu_{{ unites.id }}" name="cu_{{ unites.id }}" >{{unites.cu}}</td>
                            <td id="cieCu_{{ unites.id }}" name="cieCu_{{ unites.id }}">{{unites.cieCu}}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const unitesManualTable = new TableFlow({
        tableId: 'unitesManualTbl',
        debug: true,
        plugins: {
            names: ['edit', 'hide', 'sort', 'actions',  'choice'],
            sort: {
                sortableAttribute: 'th-sort',
                showIcons: false,
                ignoreCase: true,
                icons: {
                    asc: '<i class="fa fa-sort-asc"></i>',
                    desc: '<i class="fa fa-sort-desc"></i>',
                    none: '<i class="fa fa-sort"></i>'
                }
            },
            choice: {
                choiceAttribute: 'th-choice',
                choices: {
                    'cieCu': [
                            {% for compagnie in cies_tbl %}
                                { value: '{{ compagnie.cu }}', label: '<span style="color: {{compagnie.color}}">{{ compagnie.newName }}</span>' },
                            {% endfor %}
                    ]
                }
            },
            actions: {
                actionAttribute: 'th-actions',
                cellClass: 'td-actions',
                useIcons: true,
                debug: true,
                actions: {
                    save: {
                        autoSave: true,
                        handler: function(context) {
                            const url = "/main/actions.php";
                            actionRow(url, context.data, "unites_manuelles", "addUpdate").then(result => {
                                if (result) {
                                    successNotice('Ligne mise à jour avec succès');
                                    context.tableHandler.markRowAsSaved(context.row);
                                } else {
                                    errorNotice('Erreur lors de la mise à jour de la ligne');
                                }
                            }).catch(error => {
                                errorNotice('Erreur lors de la mise à jour de la ligne');
                                console.error('Error:', error);
                            });
                        }
                    }
                },
                labels: {
                    save: ''
                }
            }
        },
        pluginsPath: '{{ WEB_ASSETS }}/libs/tableFlow/plugins'
    });
</script>