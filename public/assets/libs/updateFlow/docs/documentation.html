
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentation UpdateFlow</title>
    <style>
        :root {
            --primary-color: #7c3aed; /* Violet */
            --secondary-color: #ec4899; /* Pink */
            --text-color: #1f2937;
            --bg-color: #ffffff;
            --code-bg: #f3f4f6;
            --border-color: #e5e7eb;
            --nav-width: 280px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--bg-color);
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1, h2, h3, h4 {
            margin: 1.5rem 0 1rem;
            color: var(--primary-color);
        }

        h1 {
            font-size: 2.8rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
        }

        h2 {
            font-size: 2rem;
            margin-top: 3rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.4rem;
        }

        h3 {
            font-size: 1.5rem;
            margin-top: 2.5rem;
            color: var(--secondary-color);
        }
         h4 {
            font-size: 1.2rem;
            margin-top: 2rem;
            color: var(--text-color);
            font-weight: 600;
        }

        p, ul, ol {
            margin-bottom: 1rem;
        }

        ul, ol {
            padding-left: 2rem;
        }

        code {
            background: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        pre {
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9em;
        }

        pre code {
            background: none;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        th, td {
            padding: 0.8rem 1rem;
            text-align: left;
            border: 1px solid var(--border-color);
            vertical-align: top;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
        }

        .example {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin: 1.5rem 0;
            background-color: #ffffff;
        }

        .example-preview {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .example-code {
            padding: 1rem;
            background: var(--code-bg);
            border-radius: 0 0 8px 8px;
        }

        .nav {
            position: fixed;
            top: 1rem;
            bottom: 1rem;
            left: 1rem;
            width: var(--nav-width);
            overflow-y: auto;
            padding: 1.5rem;
            background: var(--bg-color);
            border-right: 1px solid var(--border-color);
            font-size: 0.9em;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .nav h3 {
            margin-top: 0;
            font-size: 1.2em;
            margin-bottom: 1rem;
        }

        .nav ul {
            list-style: none;
            padding: 0;
        }
         .nav > ul > li {
             margin-bottom: 0.8rem;
             font-weight: 500;
         }
         .nav ul ul {
             padding-left: 1rem;
             margin-top: 0.3rem;
             font-weight: normal;
         }
         .nav ul ul li {
             margin-bottom: 0.3rem;
         }

        .nav a {
            color: var(--primary-color);
            text-decoration: none;
            display: block;
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .nav a:hover, .nav a.active {
            text-decoration: none;
            background-color: #f5f3ff; /* violet-50 */
            color: #5b21b6;    /* violet-800 */
        }

        .content {
            margin-left: calc(var(--nav-width) + 2rem);
        }

        .info-block, .warning-block {
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 4px;
            border-left-width: 5px;
            border-left-style: solid;
        }

        .info-block {
            background-color: #f5f3ff; /* violet-50 */
            border-color: var(--primary-color); /* violet-500 */
            color: #5b21b6; /* violet-800 */
        }

        .warning-block {
            background-color: #fffbeb;
            border-color: #facc15;
            color: #713f12;
        }

        .attr {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #db2777; /* Pink */
        }
        .type {
            font-style: italic;
            color: #7f8c8d;
        }
        .default {
             font-family: 'Courier New', Courier, monospace;
             color: #16a34a; /* Green */
             font-size: 0.9em;
        }

        @media (max-width: 1024px) {
            .nav {
                display: none;
            }
            .content {
                margin-left: 0;
            }
        }
        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }
            h1 { font-size: 2rem; }
            h2 { font-size: 1.6rem; }
            h3 { font-size: 1.2rem; }
            .container {
                 padding: 1rem;
            }
             .example-preview, .example-code {
                 padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <h3>Table des matières</h3>
            <ul>
                <li><a href="#introduction">Introduction</a></li>
                <li><a href="#architecture">Architecture</a></li>
                <li><a href="#installation">Installation</a>
                     <ul>
                        <li><a href="#installation-php">Backend (PHP)</a></li>
                        <li><a href="#installation-js">Frontend (JS)</a></li>
                    </ul>
                </li>
                <li><a href="#configuration">Configuration</a>
                    <ul>
                        <li><a href="#config-php">PHP</a></li>
                        <li><a href="#config-js">JavaScript</a></li>
                    </ul>
                </li>
                 <li><a href="#utilisation">Utilisation</a>
                    <ul>
                        <li><a href="#utilisation-js">Frontend (JS)</a></li>
                        <li><a href="#utilisation-php">Backend (PHP - API)</a></li>
                    </ul>
                </li>
                <li><a href="#securite">Sécurité</a></li>
                <li><a href="#fonctionnalites-avancees">Fonctionnalités Avancées (PHP)</a></li>
                <li><a href="#gestion-erreurs">Gestion des Erreurs</a></li>
                <li><a href="#versionnement">Versionnement</a></li>
            </ul>
        </nav>

        <div class="content">
            <h1>Documentation UpdateFlow</h1>

            <section id="introduction">
                <h2>Introduction</h2>
                <p>UpdateFlow est un système de gestion des mises à jour basé sur Git, conçu pour les applications web. Il fournit une interface JavaScript côté client pour déclencher des actions (pull, push, etc.) et une logique PHP côté serveur pour exécuter les commandes Git correspondantes de manière sécurisée.</p>
                <p>Il permet de simplifier le processus de déploiement de petites mises à jour ou de synchronisation de code entre environnements directement depuis une interface web, tout en conservant un historique via Git.</p>
            </section>

            <section id="architecture">
                <h2>Architecture</h2>
                <p>UpdateFlow est composé de deux parties principales :</p>
                <ul>
                    <li><strong>Backend (PHP) :</strong>
                        <ul>
                            <li>Exécute les commandes Git sur le serveur (<code>pull</code>, <code>push</code>, <code>commit</code>, etc.).</li>
                            <li>Gère un fichier de version (texte ou JSON) pour suivre la version actuelle.</li>
                            <li>Implémente des mécanismes de sécurité (vérification CSRF, restrictions de branche).</li>
                            <li>Offre des fonctionnalités optionnelles comme les backups automatiques, le verrouillage des opérations, et des hooks (avant/après pull/push).</li>
                            <li>Utilise des classes dédiées (<code>GitManager</code>, <code>VersionManager</code>, <code>PullHandler</code>, <code>PushHandler</code>, <code>Security</code>, <code>Logger</code>) pour une structure modulaire.</li>
                        </ul>
                    </li>
                    <li><strong>Frontend (JavaScript) :</strong>
                        <ul>
                            <li>Fournit une classe <code>UpdateFlow</code> pour interagir avec le backend via des requêtes API (Fetch).</li>
                            <li>Permet de déclencher les actions <code>pull</code>, <code>push</code>, <code>rebase</code>, <code>merge</code>, <code>reset</code>.</li>
                            <li>Intègre un système de notification pour informer l'utilisateur de la progression et des résultats.</li>
                            <li>Gère les tentatives multiples et les timeouts pour les requêtes API.</li>
                            <li>Permet de s'abonner à des événements (avant/après requête, erreur, changement de version).</li>
                            <li>Gère l'envoi du token CSRF si configuré côté PHP.</li>
                        </ul>
                    </li>
                </ul>
                <p>L'interaction typique est : l'utilisateur clique sur un bouton dans l'interface -> le JS appelle un endpoint API (ex: <code>/api/update/pull</code>) -> le script PHP de cet endpoint utilise la classe <code>UpdateFlow</code> (PHP) pour exécuter la commande Git -> PHP renvoie une réponse JSON -> JS affiche une notification à l'utilisateur.</p>
            </section>

            <section id="installation">
                <h2>Installation</h2>

                <h3 id="installation-php">Backend (PHP)</h3>
                <ol>
                    <li>
                        <strong>Copier les fichiers :</strong> Placez le contenu du dossier `src/php/` dans votre projet (par exemple, dans `src/UpdateFlow/` ou `lib/UpdateFlow/`).
                    </li>
                    <li>
                        <strong>Autoloading :</strong> Assurez-vous que l'autoloader de votre projet (probablement Composer ou un autoloader personnalisé) puisse charger les classes de l'espace de noms `UpdateFlow`. Le fichier `src/php/autoload.php` fournit un exemple simple d'autoloader spl, mais l'intégration avec Composer est recommandée :
                        <pre><code>// Dans votre composer.json
"autoload": {
    "psr-4": {
        "UpdateFlow\\": "src/UpdateFlow/" // Notez les doubles backslashes pour JSON
    }
}

// Puis lancez : composer dump-autoload</code></pre>
                    </li>
                     <li>
                        <strong>Dépendances :</strong> Le `Logger.php` fourni utilise `Monolog`. Si vous l'utilisez, installez Monolog :
                        <pre><code>composer require monolog/monolog</code></pre>
                        Sinon, adaptez la classe `Logger` ou fournissez votre propre implémentation PSR-3.
                    </li>
                    <li>
                        <strong>Permissions :</strong> Assurez-vous que le serveur web (ex: `www-data`, `apache`) a les permissions nécessaires pour :
                        <ul>
                            <li>Lire et écrire dans le dépôt Git (`repoPath`).</li>
                             <li>Exécuter des commandes `git`.</li>
                            <li>Lire et écrire le fichier de version (`versionPath`).</li>
                            <li>Écrire dans le dossier de logs (configuré dans `logger`).</li>
                             <li>Écrire dans le dossier de backups (`backupPath` si `autoBackup` est activé).</li>
                             <li>Lire et écrire le fichier de lock (`lockFile`).</li>
                        </ul>
                         Configurez également `safe.directory` dans la configuration Git globale ou locale si nécessaire pour autoriser Git à opérer sur le dépôt appartenant à un autre utilisateur.
                    </li>
                    <li>
                        <strong>Configuration Git :</strong> Assurez-vous que Git est installé sur le serveur et configuré (au moins `user.name` et `user.email`) pour pouvoir effectuer des commits, ou configurez-les via les options `gitConfig` (voir Configuration).
                    </li>
                </ol>

                <h3 id="installation-js">Frontend (JavaScript)</h3>
                 <ol>
                    <li>
                        <strong>Copier le fichier :</strong> Placez le fichier `src/updateFlow.js` dans le dossier des assets JavaScript de votre projet.
                    </li>
                    <li>
                        <strong>Inclure le script :</strong> Ajoutez le script à votre page HTML. Comme il utilise la syntaxe de classe ES6, il est préférable de le charger via une balise `script` avec `type="module"` ou de l'intégrer dans votre processus de build JavaScript (Webpack, Rollup, etc.).
                        <pre><code>&lt;script type="module" src="/path/to/assets/js/updateFlow.js"&gt;&lt;/script&gt;

&lt;!-- Dans votre script principal (aussi en module) --&gt;
&lt;script type="module"&gt;
  import UpdateFlow from '/path/to/assets/js/updateFlow.js';
  // ... initialisation et utilisation ...
&lt;/script&gt;</code></pre>
                    </li>
                    <li>
                        <strong>Notifier :</strong> Le constructeur JS requiert un objet `notifier` avec des méthodes `success`, `error`, `info`. Vous devez fournir votre propre implémentation (ex: en utilisant une bibliothèque comme Toastify, Noty, ou votre propre système).
                         <pre><code class="language-javascript">// Exemple simple de notifier
const myNotifier = {
  success: (title, message) => alert(`Succès: ${"$"}{title} - ${"$"}{message}`), // Utilisation de template literals corrigée
  error: (title, message) => alert(`Erreur: ${"$"}{title} - ${"$"}{message}`),
  info: (title, message) => alert(`Info: ${"$"}{title} - ${"$"}{message}`),
  // warning: (title, message) => alert(`Avert.: ${"$"}{title} - ${"$"}{message}`) // Optionnel
};

const updater = new UpdateFlow({ /* ... config ... */ }, myNotifier);
</code></pre>
                     </li>
                </ol>
            </section>

            <section id="configuration">
                <h2>Configuration</h2>

                <h3 id="config-php">Configuration PHP (Backend)</h3>
                <p>Passez un tableau de configuration lors de l'instanciation de <code>new UpdateFlow\UpdateFlow([...])</code>.</p>
                <table>
                    <thead><tr><th>Option</th><th>Type</th><th>Défaut</th><th>Description</th></tr></thead>
                    <tbody>
                        <tr><td><code class="attr">repoPath</code></td><td class="type">string</td><td><i>Requis</i></td><td>Chemin absolu vers la racine de votre dépôt Git local.</td></tr>
                        <tr><td><code class="attr">versionPath</code></td><td class="type">string</td><td><i>Requis</i></td><td>Chemin absolu vers le fichier contenant la version (ex: `version.txt` ou `version.json`).</td></tr>
                         <tr><td><code class="attr">logger</code></td><td class="type">array</td><td><i>Requis</i></td><td>Configuration pour le logger Monolog (ou compatible PSR-3). Ex: <code>['path' => '/path/to/updateflow.log', 'level' => \Monolog\Logger::DEBUG]</code>.</td></tr>
                        <tr><td><code class="attr">versionFormat</code></td><td class="type">string</td><td><code class="default">'text'</code></td><td>Format du fichier de version : <code>'text'</code> (contient juste X.Y.Z) ou <code>'json'</code> (contient <code>{"version": "X.Y.Z"}</code>).</td></tr>
                         <tr><td><code class="attr">allowedBranches</code></td><td class="type">array</td><td><code class="default">['main', 'master', 'develop']</code></td><td>Liste des branches sur lesquelles les opérations (push notamment) sont autorisées.</td></tr>
                         <tr><td><code class="attr">requireAuth</code></td><td class="type">boolean</td><td><code class="default">true</code></td><td>Si <code>true</code>, active la vérification du token CSRF via la classe `Security`.</td></tr>
                         <tr><td><code class="attr">autoBackup</code></td><td class="type">boolean</td><td><code class="default">false</code></td><td>Si <code>true</code>, crée un backup ZIP du dépôt avant les opérations `pull` ou `push`.</td></tr>
                         <tr><td><code class="attr">backupPath</code></td><td class="type">string</td><td><code class="default">null</code> (défaut: `repoPath`/backups)</td><td>Chemin vers le dossier où stocker les backups.</td></tr>
                         <tr><td><code class="attr">lockFile</code></td><td class="type">string</td><td><code class="default">null</code> (défaut: `repoPath`/.updateflow.lock)</td><td>Chemin vers le fichier de verrouillage pour éviter les opérations concurrentes.</td></tr>
                         <tr><td><code class="attr">hooks</code></td><td class="type">array</td><td>Voir code</td><td>Tableau associatif de callbacks : <code>prePull</code>, <code>postPull</code>, <code>prePush</code>, <code>postPush</code>. Ex: <code>'postPull' => function($context){ /* ... */ }</code>.</td></tr>
                         <tr><td><code class="attr">gitConfig</code></td><td class="type">array</td><td>Voir code</td><td>Configuration Git spécifiques : <code>userName</code>, <code>userEmail</code>, <code>token</code> (pour authentification HTTPS/SSH si nécessaire), <code>remote</code> (nom du remote, défaut 'origin').</td></tr>
                         <tr><td><code class="attr">gitOptions</code></td><td class="type">array</td><td>Voir code</td><td>Options pour les commandes Git : <code>addAll</code> (bool, ajouter tout avant commit), <code>addMoved</code> (bool, gère fichiers déplacés avec add - pas d'effet direct si addAll=true), <code>force</code> (bool, utiliser `git push --force`).</td></tr>
                         <tr><td><code class="attr">maxRetries</code></td><td class="type">int</td><td><code class="default">3</code></td><td>(Non utilisé dans le code PHP actuel) Nombre max de tentatives pour les opérations Git.</td></tr>
                         <tr><td><code class="attr">retryDelay</code></td><td class="type">int</td><td><code class="default">1000</code></td><td>(Non utilisé dans le code PHP actuel) Délai entre tentatives en ms.</td></tr>
                        <tr><td><code class="attr">timeout</code></td><td class="type">int</td><td><code class="default">30000</code></td><td>(Non utilisé dans le code PHP actuel) Timeout pour les commandes Git en ms.</td></tr>
                        <tr><td><code class="attr">debug</code></td><td class="type">boolean</td><td><code class="default">false</code></td><td>Active la journalisation détaillée (niveau DEBUG).</td></tr>
                    </tbody>
                </table>

                <h3 id="config-js">Configuration JavaScript (Frontend)</h3>
                 <p>Passez un objet de configuration et un objet `notifier` lors de l'instanciation de <code>new UpdateFlow(config, notifier)</code>.</p>
                 <table>
                     <thead><tr><th>Option</th><th>Type</th><th>Défaut</th><th>Description</th></tr></thead>
                     <tbody>
                         <tr><td><code class="attr">apiEndpoints</code></td><td class="type">object</td><td><i>Requis</i></td><td>Objet contenant les URLs des endpoints API PHP. Clés attendues : <code>pull</code>, <code>push</code>. D'autres clés (<code>rebase</code>, <code>merge</code>, <code>reset</code>) peuvent être ajoutées si vous implémentez les endpoints correspondants.</td></tr>
                         <tr><td><code class="attr">versionEndpoint</code></td><td class="type">string</td><td><i>Requis</i></td><td>URL de l'endpoint API PHP pour récupérer la version actuelle.</td></tr>
                         <tr><td><code class="attr">notifier</code></td><td class="type">object</td><td><i>Requis</i></td><td>Objet avec les méthodes <code>success(titre, msg)</code>, <code>error(titre, msg)</code>, <code>info(titre, msg)</code> pour afficher des notifications.</td></tr>
                          <tr><td><code class="attr">autoReload</code></td><td class="type">boolean</td><td><code class="default">false</code></td><td>Si <code>true</code>, recharge automatiquement la page après une opération réussie (pull, push, etc.).</td></tr>
                         <tr><td><code class="attr">retryAttempts</code></td><td class="type">number</td><td><code class="default">3</code></td><td>(Non implémenté dans le code JS actuel) Nombre de tentatives pour les requêtes API échouées.</td></tr>
                         <tr><td><code class="attr">retryDelay</code></td><td class="type">number</td><td><code class="default">1000</code></td><td>(Non implémenté dans le code JS actuel) Délai entre tentatives en ms.</td></tr>
                        <tr><td><code class="attr">timeout</code></td><td class="type">number</td><td><code class="default">30000</code></td><td>(Non implémenté dans le code JS actuel) Timeout pour les requêtes API en ms.</td></tr>
                         <tr><td><code class="attr">debug</code></td><td class="type">boolean</td><td><code class="default">false</code></td><td>Active les logs de debug dans la console JS.</td></tr>
                         <tr><td><code class="attr">headers</code></td><td class="type">object</td><td><code class="default">{'Content-Type': 'application/json'}</code></td><td>En-têtes HTTP additionnels à envoyer avec chaque requête (ex: pour authentification, token CSRF).</td></tr>
                         <tr><td><code class="attr">messages</code></td><td class="type">object</td><td>Voir code</td><td>Permet de personnaliser les messages affichés par le `notifier`.</td></tr>
                     </tbody>
                 </table>
            </section>

             <section id="utilisation">
                <h2>Utilisation</h2>

                <h3 id="utilisation-js">Frontend (JavaScript)</h3>
                <p>Utilisez l'instance de `UpdateFlow` pour déclencher des actions.</p>
                 <pre><code class="language-javascript">const notifier = { /* ... votre implémentation ... */ };
const updater = new UpdateFlow({
    apiEndpoints: { pull: '/api/pull', push: '/api/push', rebase: '/api/rebase' /* ... */ },
    versionEndpoint: '/api/version',
    headers: { 'X-CSRF-Token': 'VOTRE_TOKEN_CSRF' } // Important si requireAuth=true en PHP
}, notifier);

// Vérifier la version au chargement
console.log('Version initiale:', updater.getCurrentVersion()); // Note: peut être null initialement
updater.on('versionChange', (newVersion) => {
    console.log('La version a changé :', newVersion);
    // Mettre à jour l'UI si nécessaire
});

// Bouton Pull
document.getElementById('pull-button').addEventListener('click', async () => {
    await updater.pull();
});

// Bouton Push
document.getElementById('push-button').addEventListener('click', async () => {
    const commitMessage = prompt("Message de commit :");
    const versionType = prompt("Type de version (patch, minor, major) :", "patch");
    if (commitMessage && versionType) {
        await updater.push(commitMessage, versionType);
    }
});

// Autres actions (nécessitent des endpoints backend correspondants)
// document.getElementById('rebase-button').addEventListener('click', async () => await updater.rebase());
// document.getElementById('merge-button').addEventListener('click', async () => await updater.merge());
// document.getElementById('reset-button').addEventListener('click', async () => await updater.reset());
</code></pre>
                 <h4>Méthodes JavaScript</h4>
                 <ul>
                     <li><code>pull(): Promise&lt;void&gt;</code>: Lance une requête POST vers l'endpoint `pull`.</li>
                     <li><code>push(message, type): Promise&lt;void&gt;</code>: Lance une requête POST vers l'endpoint `push` avec le message et le type de version.</li>
                     <li><code>rebase(): Promise&lt;void&gt;</code>: Lance une requête POST vers l'endpoint `rebase`.</li>
                     <li><code>merge(): Promise&lt;void&gt;</code>: Lance une requête POST vers l'endpoint `merge`.</li>
                     <li><code>reset(): Promise&lt;void&gt;</code>: Lance une requête POST vers l'endpoint `reset`.</li>
                     <li><code>on(eventName, handler): void</code>: S'abonne à un événement (`beforeRequest`, `afterRequest`, `error`, `versionChange`).</li>
                     <li><code>off(eventName, handler): void</code>: Se désabonne d'un événement.</li>
                     <li><code>getCurrentVersion(): string | null</code>: Retourne la dernière version connue.</li>
                     <li><code>hasPendingRequests(): boolean</code>: Vérifie si des requêtes sont en cours.</li>
                 </ul>
                  <div class="warning-block">
                    <strong>Endpoints Backend Requis :</strong> Les méthodes JS <code>rebase()</code>, <code>merge()</code>, et <code>reset()</code> nécessitent que vous implémentiez les endpoints API correspondants côté serveur (PHP). La classe PHP <code>UpdateFlow</code> fournie ne contient pas de méthodes publiques directes pour ces opérations, mais vous pouvez les ajouter en utilisant les méthodes du <code>GitManager</code>.
                 </div>

                <h3 id="utilisation-php">Backend (PHP - API Endpoints)</h3>
                <p>Créez des scripts PHP qui serviront de points d'entrée pour les requêtes API du frontend. Ces scripts instancieront la classe `UpdateFlow` et appelleront les méthodes appropriées.</p>

                <h4>Exemple : Endpoint `/api/pull.php`</h4>
                 <pre><code class="language-php">&lt;?php
// Inclure l'autoloader et les dépendances (ex: Monolog)
require_once __DIR__ . '/../vendor/autoload.php'; // Si Composer
require_once __DIR__ . '/../src/php/autoload.php'; // Ou l'autoloader fourni

use UpdateFlow\UpdateFlow;
// Supposons que Response est géré autrement ou vous créez le tableau manuellement
// use UpdateFlow\Utils\Response;

// Configuration (idéalement chargée depuis un fichier)
$config = [
    'repoPath' => '/var/www/mon-projet',
    'versionPath' => '/var/www/mon-projet/version.txt',
    'logger' => ['path' => '/var/log/updateflow.log'],
    'requireAuth' => true // Activer la vérification CSRF
    // ... autres options ...
];

header('Content-Type: application/json');

try {
    $updater = new UpdateFlow($config);
    $result = $updater->pull(); // Appelle la méthode pull
    echo json_encode($result);

} catch (\UpdateFlow\Exceptions\UpdateFlowException $e) { // Echapper le backslash pour PHP dans le string Python
    http_response_code($e->getCode() >= 400 ? $e->getCode() : 400); // Utiliser le code d'erreur si valide
    echo json_encode(['status' => 'error', 'message' => $e->getMessage()]);
} catch (\Throwable $e) { // Echapper le backslash pour PHP dans le string Python
    http_response_code(500);
    error_log("Erreur UpdateFlow non gérée: " . $e->getMessage()); // Log interne
    echo json_encode(['status' => 'error', 'message' => 'Erreur serveur interne.']);
}
?&gt;</code></pre>

                <h4>Exemple : Endpoint `/api/push.php`</h4>
                 <pre><code class="language-php">&lt;?php
// ... (includes et config similaires à /api/pull.php) ...
use UpdateFlow\UpdateFlow;

header('Content-Type: application/json');

// Récupérer les données POST envoyées par le JS
$input = json_decode(file_get_contents('php://input'), true);
$message = $input['message'] ?? 'Commit automatique';
$type = $input['type'] ?? 'patch'; // patch, minor, major

if (!in_array($type, ['patch', 'minor', 'major'])) {
     http_response_code(400);
     echo json_encode(['status' => 'error', 'message' => 'Type de version invalide.']);
     exit;
}

try {
    $updater = new UpdateFlow($config);
    $result = $updater->push($message, $type); // Appelle la méthode push
    echo json_encode($result);

} catch (\UpdateFlow\Exceptions\UpdateFlowException $e) { // Echapper le backslash
    http_response_code($e->getCode() >= 400 ? $e->getCode() : 400);
    echo json_encode(['status' => 'error', 'message' => $e->getMessage()]);
} catch (\Throwable $e) { // Echapper le backslash
    http_response_code(500);
    error_log("Erreur UpdateFlow non gérée: " . $e->getMessage());
    echo json_encode(['status' => 'error', 'message' => 'Erreur serveur interne.']);
}
?&gt;</code></pre>

                <h4>Exemple : Endpoint `/api/version.php`</h4>
                 <pre><code class="language-php">&lt;?php
// ... (includes et config similaires) ...
use UpdateFlow\UpdateFlow;

header('Content-Type: application/json');

try {
    $updater = new UpdateFlow($config);
    $result = $updater->getVersion(); // Appelle la méthode getVersion
    echo json_encode($result);

} catch (\Throwable $e) { // Echapper le backslash
    http_response_code(500);
    error_log("Erreur récupération version: " . $e->getMessage());
    echo json_encode(['status' => 'error', 'message' => 'Impossible de récupérer la version.']);
}
?&gt;</code></pre>
            </section>

            <section id="securite">
                <h2>Sécurité</h2>
                 <p>UpdateFlow intègre des mécanismes pour sécuriser les opérations Git sensibles :</p>
                 <ul>
                    <li><strong>Protection CSRF :</strong> Si <code>requireAuth</code> est <code>true</code> (défaut) en PHP, la classe <code>Security</code> vérifiera la présence et la validité d'un token CSRF dans l'en-tête <code>X-CSRF-Token</code> de la requête. Le frontend JS doit être configuré pour envoyer ce token (via l'option <code>headers</code>). Vous devez générer et stocker ce token côté serveur de manière sécurisée (la classe `Security` fournit des méthodes de base mais une gestion via session est plus robuste).</li>
                     <li><strong>Restrictions de Branche :</strong> L'option PHP <code>allowedBranches</code> permet de limiter les opérations (notamment `push`) aux branches spécifiées.</li>
                     <li><strong>Permissions Serveur :</strong> Il est crucial de configurer correctement les permissions du serveur web pour qu'il puisse exécuter <code>git</code> et accéder au dépôt, mais sans accorder de droits excessifs.</li>
                     <li><strong>Authentification Git :</strong> Pour les dépôts privés, l'authentification (HTTPS avec token/mot de passe, ou SSH avec clé) doit être configurée sur le serveur où s'exécute PHP. L'option `gitConfig.token` peut être explorée pour certains cas d'usage HTTPS.</li>
                 </ul>
             </section>

            <section id="fonctionnalites-avancees">
                <h2>Fonctionnalités Avancées (PHP)</h2>
                <ul>
                    <li><strong>Hooks :</strong> Exécutez des fonctions PHP personnalisées avant ou après les opérations <code>pull</code> et <code>push</code> via l'option <code>hooks</code>. Utile pour vider un cache, lancer des migrations, etc.</li>
                    <li><strong>Backup Automatique :</strong> Activez <code>autoBackup</code> pour créer une archive ZIP du dépôt avant chaque `pull` ou `push`. Configurez le chemin avec <code>backupPath</code>.</li>
                    <li><strong>Verrouillage (Locking) :</strong> Le système utilise un fichier <code>.updateflow.lock</code> (configurable via <code>lockFile</code>) pour empêcher l'exécution simultanée de plusieurs opérations UpdateFlow, évitant ainsi les conflits potentiels.</li>
                </ul>
            </section>

             <section id="gestion-erreurs">
                <h2>Gestion des Erreurs</h2>
                <ul>
                    <li><strong>PHP :</strong> Utilise des exceptions spécifiques (<code>UpdateFlowException</code>, <code>GitException</code>, <code>VersionException</code>). Les erreurs sont logguées via le `Logger`. Les endpoints API doivent catcher ces exceptions et retourner une réponse JSON d'erreur structurée.</li>
                    <li><strong>JavaScript :</strong> Les erreurs réseau ou les réponses JSON d'erreur du backend sont interceptées. L'objet <code>notifier</code> est utilisé pour afficher les erreurs à l'utilisateur. L'événement <code>error</code> est déclenché pour une gestion personnalisée.</li>
                </ul>
            </section>

            <section id="versionnement">
                 <h2>Versionnement</h2>
                 <p>Lors d'un <code>push</code>, vous spécifiez le type d'incrémentation de version selon le Versionnement Sémantique :</p>
                <ul>
                    <li><code>patch</code> (défaut) : Pour les corrections de bugs rétrocompatibles (X.Y.Z -> X.Y.Z+1).</li>
                    <li><code>minor</code> : Pour l'ajout de fonctionnalités rétrocompatibles (X.Y.Z -> X.Y+1.0).</li>
                    <li><code>major</code> : Pour des changements non rétrocompatibles (X.Y.Z -> X+1.0.0).</li>
                </ul>
                <p>Le <code>VersionManager</code> PHP gère la lecture, l'écriture et l'incrémentation du numéro de version dans le fichier spécifié par <code>versionPath</code>.</p>
            </section>

        </div>
    </div>
    <!-- Scripts nécessaires pour les exemples interactifs (non inclus ici) -->
     <!-- Ex: <script src="/path/to/your/notifier/implementation.js"></script> -->
     <!-- Ex: <script type="module" src="/path/to/updateFlow.js"></script> -->
     <!-- Ex: <script type="module"> ... initialisation ... </script> -->
</body>
</html>
